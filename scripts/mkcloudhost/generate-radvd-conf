#!/bin/bash

cloudfunc=~/cloud.d/cloudfunc
test -e $cloudfunc || cloudfunc=$(dirname $(readlink -e $BASH_SOURCE))/cloudfunc
. $cloudfunc

host_letter=$(hostname | cut -b5)

snippet=$(mktemp)
cat <<EOF >$snippet
interface v${host_letter}<NUM>br
{
  AdvSendAdvert on;
  MinRtrAdvInterval 30;
  MaxRtrAdvInterval 100;
  AdvManagedFlag off;
  AdvOtherConfigFlag off;
  prefix <PREFIX>::/64
  {
    AdvOnLink on;
    AdvAutonomous on;
    AdvRouterAddr off;
  };
  RDNSS <PREFIX>::1
  {
    AdvRDNSSLifetime 60;
  };
};

EOF

radvd_conf=$(mktemp)
cat <<EOF>$radvd_conf
# Automatically generated by $0

EOF

for num in $(seq 1 9); do
    prefix=$(ipv6prefix $num)
    sed -e "s/<NUM>/$num/" -e "s/<PREFIX>/$prefix/" < $snippet >> $radvd_conf
done
rm $snippet
chmod 0644 $radvd_conf
echo "Config file written to $radvd_conf"

